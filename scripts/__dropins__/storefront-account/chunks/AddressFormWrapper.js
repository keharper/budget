import{jsx as g,jsxs as z,Fragment as W}from"@dropins/tools/preact-jsx-runtime.js";import{classes as O,Slot as $}from"@dropins/tools/lib.js";import{d as v,a as D,A as M,F as P}from"./AddressFormWrapper2.js";import"@dropins/tools/preact-compat.js";import{InLineAlert as S,Button as q}from"@dropins/tools/components.js";import"@dropins/tools/preact.js";import{useState as N,useEffect as R,useCallback as j,useMemo as G}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import{useText as Q}from"@dropins/tools/i18n.js";import{a as X,b as Y,g as Z,u as C,c as B}from"./updateCustomerAddress.js";import{c as E}from"./convertCase.js";const ye=({slots:e,addressesFormTitle:r,className:a,addressFormId:t,inputsDefaultValueSet:s,billingCheckBoxValue:n,shippingCheckBoxValue:m,showBillingCheckBox:d,showShippingCheckBox:o,isOpen:u,onSubmit:y,onCloseBtnClick:l,onSuccess:f,onError:A,onChange:p})=>g("div",{className:O(["dropin-address-form"]),children:g(de,{slots:e,addressesFormTitle:r,className:a,addressFormId:t,inputsDefaultValueSet:s,shippingCheckBoxValue:m,billingCheckBoxValue:n,showShippingCheckBox:o,showBillingCheckBox:d,isOpen:u,onSubmit:y,onCloseBtnClick:l,onSuccess:f,onError:A,onChange:p})}),k=()=>{const[e,r]=N(""),[a,t]=N({});R(()=>{X().then(n=>{t(m=>({...m,country_code:n}))})},[]),R(()=>{e&&Y(e).then(n=>{t(m=>({...m,region:n}))})},[e]);const s=j(n=>{n&&r(n)},[]);return{countryRegionOptions:a,handleSetCountryCode:s}},ee=(e,r)=>{const a=r.map(t=>({...t}));return a.forEach(t=>{if(Object.prototype.hasOwnProperty.call(e,t.customUpperCode)){const s=e[t.customUpperCode];if(t.customUpperCode==="region"&&typeof s=="object"){const n=s!=null&&s.regionCode&&(s!=null&&s.regionId)?`${s.regionCode},${s.regionId}`:s.region;t.defaultValue=n}else t.defaultValue=s}}),a},H=e=>{if(!e)return null;const r=new FormData(e);if(e.querySelectorAll('input[type="checkbox"]').forEach(t=>{r.has(t.name)||r.set(t.name,"false"),t.checked&&r.set(t.name,"true")}),r&&typeof r.entries=="function"){const t=r.entries();if(t&&typeof t[Symbol.iterator]=="function")return JSON.parse(JSON.stringify(Object.fromEntries(t)))||{}}return{}},te=e=>{switch(e){case"on":case"true":case 1:case"1":return!0;case"0":case"off":case"false":case 0:return!1;default:return!1}},re=e=>{const r=["region","city","company","country_code","country_id","default_billing","default_shipping","fax","firstname","lastname","middlename","postcode","prefix","street","suffix","telephone","vat_id","addressId"],a={},t=[];return Object.keys(e).forEach(s=>{r.includes(s)?a[s]=e[s]:t.push({attribute_code:s,value:e[s]})}),t.length>0&&(a.custom_attributesV2=t),a},J=e=>{const r=["street","street_1","street_2"],a=["on","off","true","false"],t=[],s={};for(const p in e){const F=e[p];a.includes(F)&&(s[p]=te(F)),r.includes(p)&&t.push(F)}const{street:n,street_2:m,street_1:d,region:o,...u}=e,[y,l]=o?o.split(","):[void 0,void 0],f=l&&y?{region_id:+l,region_code:y}:{region:y},A=re({...u,...s,region:{...f},street:t});return E(A,"camelCase",{})},se=(e,r)=>r!=null&&r.length?e.code==="region"?{...e,required:!!(r!=null&&r.length),options:r}:{...e,options:r}:e,ae=({addressFormId:e,billingCheckBoxValue:r,shippingCheckBoxValue:a,showShippingCheckBox:t,showBillingCheckBox:s,countryRegionOptions:n,inputsDefaultValueSet:m,onCloseBtnClick:d,onSuccess:o,onError:u})=>{const[y,l]=N(!1),[f,A]=N(e||""),[p,F]=N([]),[T,V]=N({text:"",type:"success"});R(()=>{Z(f?"customer_address_edit":"customer_register_address").then(i=>{F(i)})},[f]);const x=j(()=>{V({text:"",type:"success"}),d==null||d()},[d]),L=j(async(i,b)=>{if(!b)return null;l(!0);const _=H(i.target),U=J(_);await C(U).then(()=>{var c;o==null||o(),d==null||d(),(c=i==null?void 0:i.target)==null||c.reset()}).catch(c=>{V(h=>({...h,text:c.message,type:"error"})),u==null||u(c)}).finally(()=>{A(""),l(!1)})},[d,u,o]),w=j(async(i,b)=>{if(!b)return null;l(!0);const _=H(i.target),U=J(_);await B(U).then(()=>{var c;o==null||o(),d==null||d(),(c=i==null?void 0:i.target)==null||c.reset()}).catch(c=>{V(h=>({...h,text:c.message,type:"error"})),u==null||u(c)}).finally(()=>{A(""),l(!1)})},[d,u,o]),I=G(()=>{if(!p.length)return[];const i={...v,defaultValue:a,isHidden:!t},b={...D,defaultValue:r,isHidden:!s},_=[...p,i,b];return ee(m||{},_).filter(h=>!(f&&(h.customUpperCode==="defaultShipping"||h.customUpperCode==="defaultBilling")&&h.defaultValue)).map(h=>{const K=n[h.code];return se(h,K)})},[p,t,a,s,r,m,n,f]);return{inLineAlert:T,addressId:f,submitLoading:y,normalizeFieldsConfig:I,handleUpdateAddress:L,handleCreateAddress:w,handleOnCloseForm:x}},de=({slots:e,addressesFormTitle:r,className:a,addressFormId:t,inputsDefaultValueSet:s,showShippingCheckBox:n=!0,showBillingCheckBox:m=!0,shippingCheckBoxValue:d=!0,billingCheckBoxValue:o=!0,isOpen:u,onSubmit:y,onCloseBtnClick:l,onSuccess:f,onError:A,onChange:p})=>{const F=Q({secondaryButton:"Account.AddressForm.formText.secondaryButton",primaryButton:"Account.AddressForm.formText.primaryButton"}),{countryRegionOptions:T,handleSetCountryCode:V}=k(),{inLineAlert:x,addressId:L,submitLoading:w,normalizeFieldsConfig:I,handleUpdateAddress:i,handleCreateAddress:b,handleOnCloseForm:_}=ae({addressFormId:t,inputsDefaultValueSet:s,countryRegionOptions:T,shippingCheckBoxValue:d,billingCheckBoxValue:o,showShippingCheckBox:n,showBillingCheckBox:m,onSuccess:f,onError:A,onCloseBtnClick:l});return u?I!=null&&I.length?z("div",{className:O(["dropin-address-form-wrapper",a]),children:[g("div",{className:"dropin-address-form-wrapper--title","data-testid":"addressesFormTitle",children:r}),x.text?g(S,{"data-testid":"inLineAlert",className:"dropin-address-form-wrapper--notification",type:x.type,variant:"secondary",heading:x.text,icon:x.icon}):null,z(P,{slots:e,className:"dropin-address-form",name:"addressesForm",loading:w,fieldsConfig:I,onSubmit:y||(L?i:b),handleSetCountryCode:V,onChange:p,children:[L?g("input",{type:"hidden",name:"addressId",value:L,"data-testid":"hidden_test_id"}):null,g("div",{className:"dropin-field dropin-address-form-wrapper--buttons",children:e!=null&&e.AddressFormActions?g($,{"data-testid":"addressFormActions",name:"AddressFormActions",slot:e.AddressFormActions,context:{handleUpdateAddress:i,handleCreateAddress:b,addressId:L}}):z(W,{children:[g(q,{type:"button",onClick:_,variant:"secondary",disabled:w,children:F.secondaryButton}),g(q,{disabled:w,children:F.primaryButton})]})})]})]}):g("div",{children:g(M,{})}):null};export{ye as A};
